(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[902],{531:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chatting",function(){return l(1984)}])},2577:(e,t,l)=>{"use strict";l.d(t,{A:()=>a});var r=l(4848);function a(e){let{type:t="left",children:l}=e,a="";return"left"===t?a="bg-color-gray-50 rounded-r-3xl rounded-bl-3xl":"right"===t?a="bg-color-blue-300 rounded-l-3xl rounded-br-3xl text-color-gray-50":"right_select"===t?a="bg-color-gray-50 rounded-l-3xl rounded-br-3xl ":"left_say"===t&&(a="bg-color-blue-100 text-color-blue-300 rounded-r-3xl rounded-bl-3xl"),(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"".concat("left"===t||"left_say"===t?"flex justify-start":"flex justify-end"," pb-8"),children:(0,r.jsx)("div",{className:"".concat(a," bold w-fit max-w-full px-5 py-3"),children:l})})})}},1761:(e,t,l)=>{"use strict";l.d(t,{A:()=>o});var r=l(4848),a=l(6540);function o(e){let{children:t,bodyClass:l}=e;return(0,a.useEffect)(()=>(l&&document.body.classList.add(l),()=>{l&&document.body.classList.remove(l)}),[l]),(0,r.jsx)(r.Fragment,{children:t})}},1984:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>y});var r=l(4848),a=l(1761),o=l(9965),s=l.n(o),n=l(2577),c=l(6540),i=l(4996),d=l(4787);let u={getChatRooms:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{return(await i.F.get("/chatRooms?page=".concat(e,"&pageSize=").concat(t))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,planId:e.planId,planTitle:e.planTitle,planTripDate:e.planTripDate,quotePrice:e.quotePrice,lastChat:e.lastChat,isActive:e.isActive,users:e.users.map(e=>({id:e.id,nickName:e.nickName,image:e.image}))}))}catch(e){throw console.error("채팅방 목록 get 실패",e),e}},getMessages:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{let r=(await i.F.get("/chatRooms/".concat(e,"/chats?page=").concat(t,"&pageSize=").concat(l))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,senderId:e.senderId,chatRoomId:e.chatRoomId,content:e.content,type:e.type,isDeleted:e.isDeleted}));return console.log(r),r}catch(e){throw console.error("메시지 목록 get 실패",e),e}},connectWebSocket:(e,t,l)=>{let r=(0,d.io)("wss://www.goforme.duckdns.org",{transports:["websocket"],auth:{token:"".concat(e)}});return r.on("ServerToClientMessage",e=>{t(e)}),r.on("ERROR",e=>{l(e),console.error("에러발생! ".concat(e.message))}),r.on("connect",()=>{console.log("웹소켓 연결 성공 ✅")}),r.on("disconnect",()=>{console.log("웹소켓 연결 종료 ❌")}),r},sendMessage:(e,t,l,r)=>{e.emit("ClientToServerMessage",{chatRoomId:t,type:r,content:l})},fileUpload:async(e,t)=>{try{let{id:l,createdAt:r,updatedAt:a,senderId:o,type:s,chatRoomId:n,content:c}=await i.F.post("/chatRooms/".concat(e,"/chats"),t,!1,{headers:{"Content-Type":"multipart/form-data"}});return{id:l,createdAt:r,updatedAt:a,senderId:o,type:s,chatRoomId:n,content:c}}catch(e){throw console.error("파일 업로드 실패",e),e}},deleteMessage:async e=>{try{return await i.F.delete("/chats/".concat(e))}catch(e){console.error("메시지 삭제 실패",e)}}};var p=l(7452),m=l(7286),x=l(9241),g=l(3329),h=l(9502),b=l(1303);let f=async()=>(await x.A.getUserInfo()).id;function v(){let[e,t]=(0,c.useState)([]),[l,o]=(0,c.useState)(""),[i,d]=(0,c.useState)([]),[x,v]=(0,c.useState)(null),[y,j]=(0,c.useState)(null),[w,N]=(0,c.useState)(1),[k,A]=(0,c.useState)(null),[E,I]=(0,c.useState)(null),[T,S]=(0,c.useState)(!1),[C,R]=(0,c.useState)(!1),[D,_]=(0,c.useState)(!0),M=(0,c.useRef)(null),F=(0,c.useRef)(null),{data:O=[]}=(0,m.I)({queryKey:["userId"],queryFn:f}),L=async()=>{if(x){if(!y){console.error("소켓이 연결되어 있지 않습니다.");return}if((l.trim()||E)&&x){let e=E&&E.name.match(/\.(jpg|jpeg|png)$/i),r=E&&E.name.match(/\.(mp4|mov)$/i),a={id:(0,b.A)(),senderId:Array.isArray(O)?O[0]:O,chatRoomId:x.id,type:e?"IMAGE":r?"VIDEO":"TEXT",content:E?null:l.trim(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};E?await U(x.id,E,a):(u.sendMessage(y,x.id,l.trim(),"TEXT"),t(e=>[a,...e])),o(""),H(),q()}}},U=async(e,l,r)=>{let a=l.name.match(/\.(jpg|jpeg|png)$/i)?"IMAGE":"VIDEO",o=new FormData;o.append("type",a),o.append("file",l);try{let l=await u.fileUpload(e,o),a={...r,content:l.content};t(e=>[a,...e])}catch(e){console.error("파일 업로드 실패::",e)}},q=()=>{F.current&&(F.current.scrollTop=F.current.scrollHeight)},P=()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},X=(0,c.useCallback)(()=>{if(!F.current||!x||T||!D)return;let{scrollTop:e,scrollHeight:t}=F.current;0!==e||T||(S(!0),$(x.id,w+1,!0).then(()=>{N(e=>e+1),S(!1),requestAnimationFrame(()=>{F.current&&(F.current.scrollTop=F.current.scrollHeight-t)})}))},[T,D,w,x]);(0,c.useEffect)(()=>{if(!x)return;let e=F.current;if(e)return e.addEventListener("scroll",X),()=>{e.removeEventListener("scroll",X)}},[x,X]);let $=async function(e,l){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let a=await u.getMessages(e,l,10);if(0===a.length){_(!1),1!==l&&R(!0);return}a.length>0&&l>1&&R(!1),t(e=>{let t=a.filter(t=>!e.some(e=>e.id===t.id));return[...e,...t]}),r?z():requestAnimationFrame(()=>{q()})}catch(e){console.error("메시지를 가져오는데 실패했습니다.",e)}},z=()=>{if(F.current){let{scrollTop:e}=F.current;0===e?F.current.scrollTop=0:F.current.scrollTop=e}},G=async(e,l,r)=>{let a=new Date,o=new Date(r);if(a.getTime()-o.getTime()>3e5){alert("메시지는 5분 이내에만 삭제할 수 있습니다.");return}if(l!==O){alert("자신의 메시지만 삭제할 수 있습니다.");return}if(window.confirm("메시지를 삭제하시겠습니까?"))try{await u.deleteMessage(e),t(t=>t.map(t=>t.id===e?{...t,isDeleted:!0}:t))}catch(e){console.error("메시지 삭제 실패:",e),alert("메시지 삭제에 실패했습니다.")}},V=async e=>{v(e),t([]),await $(e.id,1,!1),q(),P()};(0,c.useEffect)(()=>{(async()=>{try{let e=await u.getChatRooms();d(e)}catch(e){console.error("채팅방을 가져오는데 실패했습니다.",e)}})()},[]),(0,c.useEffect)(()=>{let e=localStorage.getItem("accessToken");if(e){let l=u.connectWebSocket(e,e=>{t(t=>t.find(t=>t.id===e.id)?t:[e,...t])},e=>{alert("".concat(e.message))});return j(l),()=>{l&&l.close()}}},[]),(0,c.useEffect)(()=>{x&&(t([]),N(1),R(!1),_(!0),$(x.id,1,!1))},[x]),(0,c.useEffect)(()=>{e.length>0&&q()},[e]);let H=()=>{k&&URL.revokeObjectURL(k),A(null),I(null)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"-mx-[260px] bg-color-gray-50 py-6 mobile-tablet:mb-5 card:mb-5",children:(0,r.jsx)("p",{className:"semibold pl-[260px] text-xl",children:"메시지"})}),(0,r.jsxs)(a.A,{bodyClass:"bg-gray",children:[(0,r.jsx)("div",{className:"gap-4 overflow-x-auto rounded-xl border border-color-line-200 bg-color-gray-50 p-4 pc:hidden mobile-tablet:flex card:flex",children:0===i.length?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):i.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>V(e),className:"flex cursor-pointer flex-col rounded-lg p-3 ".concat((null==x?void 0:x.id)===e.id?"bg-color-blue-100":"bg-color-gray-50"),children:[(0,r.jsx)(s(),{src:null===(t=p.A.find(t=>{var l;return t.key===(null===(l=e.users[1])||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"}),(0,r.jsx)("p",{className:"bold mt-3 text-center",children:null===(l=e.users[1])||void 0===l?void 0:l.nickName})]},e.id)})}),(0,r.jsxs)("div",{className:"grid h-[920px] grid-cols-7 gap-10 pt-4 mobile-tablet:pt-5",children:[(0,r.jsx)("div",{className:"col-span-2 flex flex-col gap-4 overflow-y-auto rounded-xl bg-color-gray-50 p-8 mobile-tablet:hidden card:hidden",children:0===i.length?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):i.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>V(e),className:"flex cursor-pointer gap-4 rounded-xl border border-color-line-100 p-4 ".concat((null==x?void 0:x.id)===e.id?"bg-color-blue-100":"bg-white"),children:[(0,r.jsx)("div",{children:(0,r.jsx)(s(),{src:null===(t=p.A.find(t=>{var l;return t.key===(null===(l=e.users[1])||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("p",{children:null===(l=e.users[1])||void 0===l?void 0:l.nickName}),(0,r.jsx)("p",{className:"line-clamp-2",children:e.lastChat})]})]},e.id)})}),(0,r.jsxs)("div",{className:"col-span-5 rounded-xl bg-color-gray-50 p-8 mobile-tablet:col-span-7 card:col-span-7",children:[null===x?"":(0,r.jsxs)("div",{className:"mb-4 rounded-lg border border-color-line-100 p-4",children:[(0,r.jsx)("p",{className:"semibold text-2xl text-color-black-300 mobile-tablet:text-xl",children:null==x?void 0:x.planTitle}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"여행일"}),(0,r.jsx)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:(0,g.nk)((null==x?void 0:x.planTripDate)||"")}),(0,r.jsxs)("div",{className:"flex flex-row",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"플랜가"}),(0,r.jsx)(s(),{src:h.A,alt:"코코넛",width:30})]}),(0,r.jsxs)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:[null==x?void 0:x.quotePrice," P"]})]})]}),(0,r.jsx)("div",{className:"h-[600px] overflow-y-auto mobile-tablet:h-[650px]",ref:F,children:e.slice().reverse().map((e,t)=>(0,r.jsxs)("div",{children:[0===t&&C&&!D&&(0,r.jsx)("div",{className:"text-color-blue-500 semibold my-4 text-center",children:"첫 번째 메시지입니다."}),(0,r.jsx)("div",{onClick:()=>!e.isDeleted&&G(e.id,e.senderId,e.createdAt),className:"cursor-pointer",children:(0,r.jsx)(n.A,{type:e.senderId===O?"right":"left_say",children:e.isDeleted?(0,r.jsxs)("p",{className:"text-color-gray-50",children:["TEXT"===e.type&&"삭제된 메시지입니다.","IMAGE"===e.type&&"삭제된 이미지입니다.","VIDEO"===e.type&&"삭제된 동영상입니다."]}):"IMAGE"===e.type?(0,r.jsx)("img",{src:e.content||"",alt:"file",className:"w-28 rounded-lg"}):"VIDEO"===e.type?(0,r.jsx)("video",{controls:!0,className:"w-full rounded-lg",children:(0,r.jsx)("source",{src:e.content||"",type:"video/mp4"})}):(0,r.jsx)("p",{children:e.content})},e.id)})]},e.id))}),(0,r.jsxs)("div",{className:"flex flex-col gap-5",ref:M,children:[(0,r.jsx)("input",{className:"h-16 w-full rounded-xl bg-color-background-200 indent-5 text-color-black-500 outline-none mobile-tablet:h-10",placeholder:"텍스트를 입력해 주세요.",onChange:e=>o(e.target.value),value:l,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),L())}}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("input",{type:"file",className:"hidden",id:"fileUpload",onChange:e=>{let t=e.target.files?e.target.files[0]:null;if(t){let l=t.name.match(/\.(jpg|jpeg|png)$/i),r=t.name.match(/\.(mp4|mov)$/i);if(l&&t.size>5242880){alert("이미지는 5MB 이하로 업로드할 수 있습니다."),e.target.value="";return}if(r&&t.size>0x6400000){alert("비디오는 100MB 이하로 업로드할 수 있습니다."),e.target.value="";return}k&&URL.revokeObjectURL(k);let a=URL.createObjectURL(t);I(t),A(a),e.target.value=""}}}),(0,r.jsx)("label",{htmlFor:"fileUpload",className:"cursor-pointer rounded-xl border border-color-blue-300 bg-color-blue-100 px-6 py-3 text-lg text-color-blue-300 mobile-tablet:px-4 mobile-tablet:py-1",children:"첨부파일"}),(0,r.jsx)("button",{onClick:L,className:"rounded-xl bg-color-blue-300 px-6 py-3 text-lg text-color-gray-50 mobile-tablet:px-4 mobile-tablet:py-1",children:"전송"})]}),k&&(0,r.jsx)("div",{className:"mb-3 mt-3",children:(()=>{var e;if(!k)return null;let t=null==E?void 0:null===(e=E.name.split(".").pop())||void 0===e?void 0:e.toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("img",{src:k,alt:"file-preview",className:"h-auto w-28 rounded-lg"}),(0,r.jsx)("button",{onClick:H,className:"absolute left-[85px] top-1 rounded-full bg-color-red-200 px-2 text-color-gray-50 hover:bg-color-red-100",children:(0,r.jsx)("p",{children:"x"})})]}):"mp4"===t||"mov"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("video",{controls:!0,className:"h-auto w-full rounded-lg",children:(0,r.jsx)("source",{src:k,type:"video/".concat(t)})}),(0,r.jsx)("button",{onClick:H,className:"absolute right-2 top-2 rounded-full bg-white p-2 text-color-red-200 hover:bg-gray-200",children:(0,r.jsx)("span",{className:"text-xl",children:"x"})})]}):(0,r.jsx)("p",{children:"지원되지 않는 파일 형식입니다."})})()})]})]})]})]})]})}function y(){return(0,r.jsx)(v,{})}}},e=>{var t=t=>e(e.s=t);e.O(0,[913,636,593,792],()=>t(531)),_N_E=e.O()}]);