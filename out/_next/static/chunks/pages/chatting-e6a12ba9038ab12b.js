(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[902],{50531:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chatting",function(){return l(98437)}])},5279:(e,t,l)=>{"use strict";l.d(t,{A:()=>r});let r={src:"/_next/static/media/icon_loading.05325840.gif",height:45,width:256,blurWidth:0,blurHeight:0}},82577:(e,t,l)=>{"use strict";l.d(t,{A:()=>a});var r=l(74848);function a(e){let{type:t="left",children:l}=e,a="";return"left"===t?a="bg-color-gray-50 rounded-r-3xl rounded-bl-3xl":"right"===t?a="bg-color-blue-300 rounded-l-3xl rounded-br-3xl text-color-gray-50":"right_select"===t?a="bg-color-gray-50 rounded-l-3xl rounded-br-3xl ":"left_say"===t&&(a="bg-color-blue-100 text-color-blue-300 rounded-r-3xl rounded-bl-3xl"),(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"".concat("left"===t||"left_say"===t?"flex justify-start":"flex justify-end"," pb-8"),children:(0,r.jsx)("div",{className:"".concat(a," bold w-fit max-w-full px-5 py-3"),children:l})})})}},51761:(e,t,l)=>{"use strict";l.d(t,{A:()=>s});var r=l(74848),a=l(96540);function s(e){let{children:t,bodyClass:l}=e;return(0,a.useEffect)(()=>(l&&document.body.classList.add(l),()=>{l&&document.body.classList.remove(l)}),[l]),(0,r.jsx)(r.Fragment,{children:t})}},98437:(e,t,l)=>{"use strict";l.r(t),l.d(t,{ChattingPage:()=>N,default:()=>E});var r=l(74848),a=l(51761),s=l(82577),o=l(96540),n=l(97286),i=l(12828),c=l(3329),d=l(84996),u=l(54787),p=l(6220);let m={getChatRooms:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{return(await d.F.get("/chatRooms?page=".concat(e,"&pageSize=").concat(t))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,planId:e.planId,planTitle:e.planTitle,planTripDate:e.planTripDate,quotePrice:e.quotePrice,lastChat:e.lastChat,isActive:e.isActive,users:e.users.map(e=>({id:e.id,nickName:e.nickName,image:e.image}))}))}catch(e){throw console.error("채팅방 목록 조회에 실패했습니다.",e),e}},getMessages:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{return(await d.F.get("/chatRooms/".concat(e,"/chats?page=").concat(t,"&pageSize=").concat(l))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,senderId:e.senderId,chatRoomId:e.chatRoomId,content:e.content,type:e.type,isDeleted:e.isDeleted}))}catch(e){if(e.response&&e.response.status===p.AY)throw Error("해당 채팅방 유저가 아닙니다.");throw Error("해당 채팅방이 없습니다.")}},connectWebSocket:(e,t,l)=>{let r=(0,u.io)("wss://www.goforme.duckdns.org",{transports:["websocket"],auth:{token:"".concat(e)}});return r.on("ServerToClientMessage",e=>{t(e)}),r.on("ERROR",e=>{l(e),console.error("에러발생! ".concat(e.message))}),r.on("connect",()=>{console.log("웹소켓 연결 성공 ✅")}),r.on("disconnect",()=>{console.log("웹소켓 연결 종료 ❌")}),r},sendMessage:(e,t,l,r)=>{e.emit("ClientToServerMessage",{chatRoomId:t,type:r,content:l})},fileUpload:async(e,t)=>{try{let{id:l,createdAt:r,updatedAt:a,senderId:s,type:o,chatRoomId:n,content:i}=await d.F.post("/chatRooms/".concat(e,"/chats"),t,!1,{headers:{"Content-Type":"multipart/form-data"}});return{id:l,createdAt:r,updatedAt:a,senderId:s,type:o,chatRoomId:n,content:i}}catch(e){throw console.error("파일 업로드 실패",e),e}},deleteMessage:async e=>{try{return await d.F.delete("/chats/".concat(e))}catch(e){if(e.response&&e.response.status===p.p2)throw Error("해당 채팅은 이미 삭제되었거나 없는 채팅입니다.");if(e.response&&e.response.status===p.qH)throw Error("해당 채팅방은 비활성화가 되었습니다.");if(e.response&&e.response.status===p.p9)throw Error("이미 삭제된 메시지입니다.")}},downloadFile:async e=>{try{return await d.F.get("/chats/".concat(e,"/downloadFile"))}catch(e){if(e.response&&e.response.status===p.p2)throw Error("내용이 없습니다.");if(e.response&&e.response.status===p.qH)throw Error("텍스트이거나 삭제된 메시지입니다.");if(e.response&&e.response.status===p.AY)throw Error("본인이 속한 채팅방이 아닙니다.")}}};var h=l(79241),g=l(28775),x=l(21303),f=l(29965),b=l.n(f),v=l(5279);let j={src:"/_next/static/media/icon_download.9fac6e69.png",height:640,width:640,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAOVBMVEVMaXFumtiBs/+30PV5rfaFuP+Uwf9kjemCt/9/tf6NtfChveNgjNOpx/XJ3/+Mt/h7p+lznNd6o+D18/bHAAAAEnRSTlMAz9H+Lc7+B/46/f46/f79//7QMxuzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPElEQVR4nBXLQRKAIAwEwUESdgNqwf8/a9n3BlQlgLjsK0DpMZ2iPPqaLsp++9mFcjxrN0HkPi3+proFHzclAZ2juowSAAAAAElFTkSuQmCC",blurWidth:8,blurHeight:8};var y=l(49502);let A=async()=>(await h.A.getUserInfo()).id;function w(){let[e,t]=(0,o.useState)([]),[l,d]=(0,o.useState)(""),[u,p]=(0,o.useState)(null),[h,f]=(0,o.useState)(null),[w,N]=(0,o.useState)(1),[E,k]=(0,o.useState)(null),[C,I]=(0,o.useState)(null),[R,S]=(0,o.useState)(!1),[T,D]=(0,o.useState)(!1),[F,M]=(0,o.useState)(!0),[_,L]=(0,o.useState)(null),U=(0,o.useRef)(null),P=(0,o.useRef)(null),{data:O=""}=(0,n.I)({queryKey:["userId"],queryFn:A}),{data:q=[],isLoading:H}=(0,n.I)({queryKey:["chatRooms"],queryFn:async()=>await m.getChatRooms(1,10)}),V=async()=>{if(u){if(!h){console.error("소켓이 연결되어 있지 않습니다.");return}if((l.trim()||C)&&u){let e=C&&C.name.match(/\.(jpg|jpeg|png)$/i),r=C&&C.name.match(/\.(mp4|mov)$/i),a={id:(0,x.A)(),senderId:Array.isArray(O)?O[0]:O,chatRoomId:u.id,type:e?"IMAGE":r?"VIDEO":"TEXT",content:C?null:l.trim(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};C?await X(u.id,C,a):(m.sendMessage(h,u.id,l.trim(),"TEXT"),t(e=>[a,...e])),d(""),et(),z()}}},X=async(e,l,r)=>{let a=l.name.match(/\.(jpg|jpeg|png)$/i)?"IMAGE":"VIDEO",s=new FormData;s.append("type",a),s.append("file",l);try{let l=await m.fileUpload(e,s),a={...r,content:l.content};t(e=>[a,...e])}catch(e){console.error("파일 업로드 실패::",e)}},z=()=>{P.current&&(P.current.scrollTop=P.current.scrollHeight)},B=()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},K=(0,o.useCallback)(()=>{if(!P.current||!u||R||!F)return;let{scrollTop:e,scrollHeight:t}=P.current;0!==e||R||(S(!0),W(u.id,w+1,!0).then(()=>{N(e=>e+1),S(!1),requestAnimationFrame(()=>{P.current&&(P.current.scrollTop=P.current.scrollHeight-t)})}))},[R,F,w,u]);(0,o.useEffect)(()=>{if(!u)return;let e=P.current;if(e)return e.addEventListener("scroll",K),()=>{e.removeEventListener("scroll",K)}},[u,K]);let W=async function(e,l){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let a=await m.getMessages(e,l,10);if(0===a.length){M(!1),1!==l&&D(!0);return}a.length>0&&l>1&&D(!1),t(e=>{let t=a.filter(t=>!e.some(e=>e.id===t.id));return[...e,...t]}),r?G():requestAnimationFrame(()=>{z()})}catch(e){alert(e.message)}},G=()=>{if(P.current){let{scrollTop:e}=P.current;0===e?P.current.scrollTop=0:P.current.scrollTop=e}},Q=e=>{L(t=>t===e?null:e)},$=async(e,l,r)=>{let a=new Date,s=new Date(r);if(a.getTime()-s.getTime()>3e5){alert("메시지는 5분 이내에만 삭제할 수 있습니다.");return}if(l!==O){alert("자신의 메시지만 삭제할 수 있습니다.");return}if(window.confirm("메시지를 삭제하시겠습니까?"))try{await m.deleteMessage(e),t(t=>t.map(t=>t.id===e?{...t,isDeleted:!0}:t))}catch(e){alert(e.message)}},Y=T&&!F,Z=0===q.length,J=async e=>{p(e),t([]),await W(e.id,1,!1),z(),B()},ee=async e=>{if(u)try{let t=await m.downloadFile(e);if(!t.startsWith("http")){console.error("올바른 URL이 아닙니다:",t);return}window.open(t,"_blank")}catch(e){alert(e.message)}};(0,o.useEffect)(()=>{let e=(0,i.iD)();if(e){let l=m.connectWebSocket(e,e=>{t(t=>t.find(t=>t.id===e.id)?t:[e,...t])},e=>{alert("".concat(e.message))});return f(l),()=>{l&&l.close()}}},[]),(0,o.useEffect)(()=>{u&&(t([]),N(1),D(!1),M(!0),W(u.id,1,!1))},[u]),(0,o.useEffect)(()=>{e.length>0&&z()},[e]);let et=()=>{E&&URL.revokeObjectURL(E),k(null),I(null)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"-mx-[260px] bg-color-gray-50 py-6 mobile-tablet:mb-5 card:mb-5",children:(0,r.jsx)("p",{className:"semibold pl-[260px] text-xl",children:"메시지"})}),(0,r.jsx)(a.A,{bodyClass:"bg-gray",children:H?(0,r.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,r.jsx)(b(),{src:v.A,alt:"로딩 중"})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"gap-4 overflow-x-auto rounded-xl border border-color-line-200 bg-color-gray-50 p-4 pc:hidden mobile-tablet:flex card:flex",children:Z?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):q.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>J(e),className:"flex cursor-pointer flex-col rounded-lg p-3 hover:scale-[1.1] ".concat((null==u?void 0:u.id)===e.id?"bg-color-blue-100":"bg-[#fcfcfc]"),children:[(0,r.jsx)(b(),{src:null===(t=g.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==O))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"}),(0,r.jsx)("p",{className:"bold mt-3 text-center",children:null===(l=e.users.find(e=>e.id!==O))||void 0===l?void 0:l.nickName})]},e.id)})}),(0,r.jsxs)("div",{className:"grid h-[920px] grid-cols-7 gap-10 pt-4 mobile-tablet:pt-5",children:[(0,r.jsx)("div",{className:"col-span-2 flex flex-col gap-4 overflow-y-auto rounded-xl bg-color-gray-50 p-8 mobile-tablet:hidden card:hidden",children:Z?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):q.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>J(e),className:"flex cursor-pointer gap-4 rounded-xl border border-color-line-100 p-4 hover:scale-[1.1] ".concat((null==u?void 0:u.id)===e.id?"bg-color-blue-100":"bg-[#fcfcfc]"),children:[(0,r.jsx)("div",{children:(0,r.jsx)(b(),{src:null===(t=g.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==O))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("p",{children:null===(l=e.users.find(e=>e.id!==O))||void 0===l?void 0:l.nickName}),(0,r.jsx)("p",{className:"line-clamp-2",children:e.lastChat})]})]},e.id)})}),(0,r.jsxs)("div",{className:"col-span-5 rounded-xl bg-color-gray-50 p-8 mobile-tablet:col-span-7 card:col-span-7",children:[null===u?"":(0,r.jsxs)("div",{className:"mb-4 rounded-lg border border-color-line-100 p-4",children:[(0,r.jsx)("p",{className:"semibold text-2xl text-color-black-300 mobile-tablet:text-xl",children:null==u?void 0:u.planTitle}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"여행일"}),(0,r.jsx)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:(0,c.nk)((null==u?void 0:u.planTripDate)||"")}),(0,r.jsxs)("div",{className:"flex flex-row",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"플랜가"}),(0,r.jsx)(b(),{src:y.A,alt:"코코넛",width:30})]}),(0,r.jsxs)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:[null==u?void 0:u.quotePrice," P"]})]})]}),(0,r.jsx)("div",{className:"h-[600px] overflow-y-auto mobile-tablet:h-[650px]",ref:P,children:e.slice().reverse().map((e,t)=>(0,r.jsxs)("div",{children:[0===t&&Y&&(0,r.jsx)("div",{className:"text-color-blue-500 semibold my-4 text-center",children:"첫 번째 메시지입니다."}),(0,r.jsxs)("div",{onClick:()=>Q(e.id),className:"relative mb-2 cursor-pointer",children:[(0,r.jsx)(s.A,{type:e.senderId===O?"right":"left_say",children:e.isDeleted?(0,r.jsxs)("p",{className:"text-color-gray-50",children:["TEXT"===e.type&&"삭제된 메시지입니다.","IMAGE"===e.type&&"삭제된 이미지입니다.","VIDEO"===e.type&&"삭제된 동영상입니다."]}):"IMAGE"===e.type?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("img",{src:e.content||"",alt:"file",className:"w-56 rounded-lg"})}),(0,r.jsx)(b(),{src:j,alt:"다운로드",className:"absolute bottom-0 right-2 h-8 w-8 cursor-pointer",onClick:t=>{ee(e.id),t.stopPropagation()}})]}):"VIDEO"===e.type?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("video",{controls:!0,className:"h-96 rounded-lg",children:(0,r.jsx)("source",{src:e.content||"",type:"video/mp4"})})}),(0,r.jsx)(b(),{src:j,alt:"다운로드",className:"absolute bottom-0 right-2 h-8 w-8 cursor-pointer",onClick:t=>{ee(e.id),t.stopPropagation()}})]}):(0,r.jsx)("p",{children:e.content})},e.id),_===e.id&&!e.isDeleted&&(0,r.jsx)("div",{onClick:t=>{t.stopPropagation(),$(e.id,e.senderId,e.createdAt),L(null)},className:"bold absolute bottom-0 right-0 w-[107px] cursor-pointer rounded-md border border-color-black-500 bg-color-gray-100 px-2",children:"메시지 삭제"})]})]},e.id))}),(0,r.jsxs)("div",{className:"flex flex-col gap-5",ref:U,children:[(0,r.jsx)("input",{className:"h-16 w-full rounded-xl bg-color-background-200 indent-5 text-color-black-500 outline-none mobile-tablet:h-10",placeholder:"텍스트를 입력해 주세요.",onChange:e=>d(e.target.value),value:l,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),V())}}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("input",{type:"file",className:"hidden",id:"fileUpload",onChange:e=>{let t=e.target.files?e.target.files[0]:null;if(t){let l=t.name.match(/\.(jpg|jpeg|png)$/i),r=t.name.match(/\.(mp4|mov)$/i);if(l&&t.size>5242880){alert("이미지는 5MB 이하로 업로드할 수 있습니다."),e.target.value="";return}if(r&&t.size>0x6400000){alert("비디오는 100MB 이하로 업로드할 수 있습니다."),e.target.value="";return}E&&URL.revokeObjectURL(E);let a=URL.createObjectURL(t);I(t),k(a),e.target.value=""}}}),(0,r.jsx)("label",{htmlFor:"fileUpload",className:"cursor-pointer rounded-xl border border-color-blue-300 bg-color-blue-100 px-6 py-3 text-lg text-color-blue-300 mobile-tablet:px-4 mobile-tablet:py-1",children:"첨부파일"}),(0,r.jsx)("button",{onClick:V,className:"rounded-xl bg-color-blue-300 px-6 py-3 text-lg text-color-gray-50 mobile-tablet:px-4 mobile-tablet:py-1",children:"전송"})]}),E&&(0,r.jsx)("div",{className:"mb-3 mt-3",children:(()=>{var e;if(!E)return null;let t=null==C?void 0:null===(e=C.name.split(".").pop())||void 0===e?void 0:e.toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("img",{src:E,alt:"file-preview",className:"h-auto w-28 rounded-lg"}),(0,r.jsx)("button",{onClick:et,className:"absolute left-[85px] top-1 rounded-full bg-color-red-200 px-2 text-color-gray-50 hover:bg-color-red-100",children:(0,r.jsx)("p",{children:"x"})})]}):"mp4"===t||"mov"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("video",{controls:!0,className:"h-auto w-full rounded-lg",children:(0,r.jsx)("source",{src:E,type:"video/".concat(t)})}),(0,r.jsx)("button",{onClick:et,className:"absolute right-2 top-2 rounded-full bg-white p-2 text-color-red-200 hover:bg-gray-200",children:(0,r.jsx)("span",{className:"text-xl",children:"x"})})]}):(0,r.jsx)("p",{children:"지원되지 않는 파일 형식입니다. (이미지는 jpg, jpeg, png / 비디오는 mp4, mov만 업로드 가능)"})})()})]})]})]})]})})]})}function N(){return(0,r.jsx)(w,{})}let E=(0,l(4107).A)(N)},4107:(e,t,l)=>{"use strict";l.d(t,{A:()=>d});var r=l(74848),a=l(96540),s=l(86715),o=l(12828),n=l(5279),i=l(29965),c=l.n(i);let d=e=>t=>{let l=(0,s.useRouter)(),[i,d]=(0,a.useState)(null),[u,p]=(0,a.useState)(!0);return((0,a.useEffect)(()=>{let e=(0,o.iD)();if(e){if("/login"===l.pathname||"/signup"===l.pathname){l.push("/");return}d(e)}else"/login"!==l.pathname&&"/signup"!==l.pathname&&l.push("/login");p(!1)},[l]),u)?(0,r.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,r.jsx)(c(),{src:n.A,alt:"로딩 중"})}):i||"/login"===l.pathname||"/signup"===l.pathname?(0,r.jsx)(e,{...t}):null}}},e=>{var t=t=>e(e.s=t);e.O(0,[913,636,593,792],()=>t(50531)),_N_E=e.O()}]);