(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[902],{50531:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chatting",function(){return l(98437)}])},5279:(e,t,l)=>{"use strict";l.d(t,{A:()=>r});let r={src:"/_next/static/media/icon_loading.05325840.gif",height:45,width:256,blurWidth:0,blurHeight:0}},82577:(e,t,l)=>{"use strict";l.d(t,{A:()=>a});var r=l(74848);function a(e){let{type:t="left",children:l}=e,a="";return"left"===t?a="bg-color-gray-50 rounded-r-3xl rounded-bl-3xl":"right"===t?a="bg-color-blue-300 rounded-l-3xl rounded-br-3xl text-color-gray-50":"right_select"===t?a="bg-color-gray-50 rounded-l-3xl rounded-br-3xl ":"left_say"===t&&(a="bg-color-blue-100 text-color-blue-300 rounded-r-3xl rounded-bl-3xl"),(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"".concat("left"===t||"left_say"===t?"flex justify-start":"flex justify-end"," pb-8"),children:(0,r.jsx)("div",{className:"".concat(a," bold w-fit max-w-full px-5 py-3"),children:l})})})}},51761:(e,t,l)=>{"use strict";l.d(t,{A:()=>s});var r=l(74848),a=l(96540);function s(e){let{children:t,bodyClass:l}=e;return(0,a.useEffect)(()=>(l&&document.body.classList.add(l),()=>{l&&document.body.classList.remove(l)}),[l]),(0,r.jsx)(r.Fragment,{children:t})}},98437:(e,t,l)=>{"use strict";l.r(t),l.d(t,{ChattingPage:()=>C,default:()=>I});var r=l(74848),a=l(77528),s=l(55456),o=l(51761),n=l(82577),i=l(96540),c=l(97286),d=l(12828),u=l(3329),p=l(84996),h=l(54787),m=l(6220),g=l(77836);let x={getChatRooms:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{return(await p.F.get("/chatRooms?page=".concat(e,"&pageSize=").concat(t))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,planId:e.planId,planTitle:e.planTitle,planTripDate:e.planTripDate,quotePrice:e.quotePrice,lastChat:e.lastChat,isActive:e.isActive,users:e.users.map(e=>({id:e.id,nickName:e.nickName,image:e.image}))}))}catch(e){throw console.error("채팅방 목록 조회에 실패했습니다.",e),e}},getMessages:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{return(await p.F.get("/chatRooms/".concat(e,"/chats?page=").concat(t,"&pageSize=").concat(l))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,senderId:e.senderId,chatRoomId:e.chatRoomId,content:e.content,type:e.type,isDeleted:e.isDeleted}))}catch(e){if(e.response&&e.response.status===m.AY)throw Error("해당 채팅방 유저가 아닙니다.");throw Error("해당 채팅방이 없습니다.")}},connectWebSocket:(e,t,l)=>{let r=(0,h.io)(g.env.NEXT_PUBLIC_WEB_URL,{transports:["websocket"],auth:{token:"".concat(e)}});return r.on("ServerToClientMessage",e=>{t(e)}),r.on("ERROR",e=>{l(e),console.error("에러발생! ".concat(e.message))}),r.on("connect",()=>{console.log("웹소켓 연결 성공 ✅")}),r.on("disconnect",()=>{console.log("웹소켓 연결 종료 ❌")}),r},sendMessage:(e,t,l,r)=>{e.emit("ClientToServerMessage",{chatRoomId:t,type:r,content:l})},fileUpload:async(e,t)=>{try{let{id:l,createdAt:r,updatedAt:a,senderId:s,type:o,chatRoomId:n,content:i}=await p.F.post("/chatRooms/".concat(e,"/chats"),t,!1,{headers:{"Content-Type":"multipart/form-data"}});return{id:l,createdAt:r,updatedAt:a,senderId:s,type:o,chatRoomId:n,content:i}}catch(e){throw console.error("파일 업로드 실패",e),e}},deleteMessage:async e=>{try{return await p.F.delete("/chats/".concat(e))}catch(e){if(e.response&&e.response.status===m.p2)throw Error("해당 채팅은 이미 삭제되었거나 없는 채팅입니다.");if(e.response&&e.response.status===m.qH)throw Error("해당 채팅방은 비활성화가 되었습니다.");if(e.response&&e.response.status===m.p9)throw Error("이미 삭제된 메시지입니다.")}},downloadFile:async e=>{try{return await p.F.get("/chats/".concat(e,"/downloadFile"))}catch(e){if(e.response&&e.response.status===m.p2)throw Error("내용이 없습니다.");if(e.response&&e.response.status===m.qH)throw Error("텍스트이거나 삭제된 메시지입니다.");if(e.response&&e.response.status===m.AY)throw Error("본인이 속한 채팅방이 아닙니다.")}}};var f=l(79241),b=l(28775),v=l(21303),j=l(29965),y=l.n(j),A=l(5279);let w={src:"/_next/static/media/icon_download.9fac6e69.png",height:640,width:640,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAOVBMVEVMaXFumtiBs/+30PV5rfaFuP+Uwf9kjemCt/9/tf6NtfChveNgjNOpx/XJ3/+Mt/h7p+lznNd6o+D18/bHAAAAEnRSTlMAz9H+Lc7+B/46/f46/f79//7QMxuzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAPElEQVR4nBXLQRKAIAwEwUESdgNqwf8/a9n3BlQlgLjsK0DpMZ2iPPqaLsp++9mFcjxrN0HkPi3+proFHzclAZ2juowSAAAAAElFTkSuQmCC",blurWidth:8,blurHeight:8};var N=l(49502);let E=async()=>(await f.A.getUserInfo()).id;function k(){let[e,t]=(0,i.useState)([]),[l,p]=(0,i.useState)(""),[h,m]=(0,i.useState)(null),[g,f]=(0,i.useState)(null),[j,k]=(0,i.useState)(1),[C,I]=(0,i.useState)(null),[R,_]=(0,i.useState)(null),[S,T]=(0,i.useState)(!1),[D,F]=(0,i.useState)(!1),[M,L]=(0,i.useState)(!0),[U,P]=(0,i.useState)(null),O=(0,i.useRef)(null),q=(0,i.useRef)(null),{data:B=""}=(0,c.I)({queryKey:["userId"],queryFn:E}),{data:H=[],isLoading:X}=(0,c.I)({queryKey:["chatRooms"],queryFn:async()=>await x.getChatRooms(1,10)}),V=async()=>{if(h){if(!g){console.error("소켓이 연결되어 있지 않습니다.");return}if((l.trim()||R)&&h){let e=R&&R.name.match(/\.(jpg|jpeg|png)$/i),r=R&&R.name.match(/\.(mp4|mov)$/i),a={id:(0,v.A)(),senderId:Array.isArray(B)?B[0]:B,chatRoomId:h.id,type:e?"IMAGE":r?"VIDEO":"TEXT",content:R?null:l.trim(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};R?await z(h.id,R,a):(x.sendMessage(g,h.id,l.trim(),"TEXT"),t(e=>[a,...e])),p(""),er(),W()}}},z=async(e,l,r)=>{let o=l.name.match(/\.(jpg|jpeg|png)$/i)?"IMAGE":"VIDEO",n=new FormData;n.append("type",o),n.append("file",l);try{let l=await x.fileUpload(e,n),o=(0,s._)((0,a._)({},r),{content:l.content});t(e=>[o,...e])}catch(e){console.error("파일 업로드 실패::",e)}},W=()=>{q.current&&(q.current.scrollTop=q.current.scrollHeight)},K=()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},G=(0,i.useCallback)(()=>{if(!q.current||!h||S||!M)return;let{scrollTop:e,scrollHeight:t}=q.current;0!==e||S||(T(!0),Q(h.id,j+1,!0).then(()=>{k(e=>e+1),T(!1),requestAnimationFrame(()=>{q.current&&(q.current.scrollTop=q.current.scrollHeight-t)})}))},[S,M,j,h]);(0,i.useEffect)(()=>{if(!h)return;let e=q.current;if(e)return e.addEventListener("scroll",G),()=>{e.removeEventListener("scroll",G)}},[h,G]);let Q=async function(e,l){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let a=await x.getMessages(e,l,10);if(0===a.length){L(!1),1!==l&&F(!0);return}a.length>0&&l>1&&F(!1),t(e=>{let t=a.filter(t=>!e.some(e=>e.id===t.id));return[...e,...t]}),r?$():requestAnimationFrame(()=>{W()})}catch(e){alert(e.message)}},$=()=>{if(q.current){let{scrollTop:e}=q.current;0===e?q.current.scrollTop=0:q.current.scrollTop=e}},Y=e=>{P(t=>t===e?null:e)},Z=async(e,l,r)=>{let o=new Date,n=new Date(r);if(o.getTime()-n.getTime()>3e5){alert("메시지는 5분 이내에만 삭제할 수 있습니다.");return}if(l!==B){alert("자신의 메시지만 삭제할 수 있습니다.");return}if(window.confirm("메시지를 삭제하시겠습니까?"))try{await x.deleteMessage(e),t(t=>t.map(t=>t.id===e?(0,s._)((0,a._)({},t),{isDeleted:!0}):t))}catch(e){alert(e.message)}},J=D&&!M,ee=0===H.length,et=async e=>{m(e),t([]),await Q(e.id,1,!1),W(),K()},el=async e=>{if(h)try{let t=await x.downloadFile(e);if(!t.startsWith("http")){console.error("올바른 URL이 아닙니다:",t);return}window.open(t,"_blank")}catch(e){alert(e.message)}};(0,i.useEffect)(()=>{let e=(0,d.iD)();if(e){let l=x.connectWebSocket(e,e=>{t(t=>t.find(t=>t.id===e.id)?t:[e,...t])},e=>{alert("".concat(e.message))});return f(l),()=>{l&&l.close()}}},[]),(0,i.useEffect)(()=>{h&&(t([]),k(1),F(!1),L(!0),Q(h.id,1,!1))},[h]),(0,i.useEffect)(()=>{e.length>0&&W()},[e]);let er=()=>{C&&URL.revokeObjectURL(C),I(null),_(null)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"-mx-[260px] bg-color-gray-50 py-6 mobile-tablet:mb-5 card:mb-5",children:(0,r.jsx)("p",{className:"semibold pl-[260px] text-xl",children:"메시지"})}),(0,r.jsx)(o.A,{bodyClass:"bg-gray",children:X?(0,r.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,r.jsx)(y(),{src:A.A,alt:"로딩 중"})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"gap-4 overflow-x-auto rounded-xl border border-color-line-200 bg-color-gray-50 p-4 pc:hidden mobile-tablet:flex card:flex",children:ee?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):H.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>et(e),className:"flex cursor-pointer flex-col rounded-lg p-3 hover:scale-[1.1] ".concat((null==h?void 0:h.id)===e.id?"bg-color-blue-100":"bg-[#fcfcfc]"),children:[(0,r.jsx)(y(),{src:null===(t=b.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==B))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"}),(0,r.jsx)("p",{className:"bold mt-3 text-center",children:null===(l=e.users.find(e=>e.id!==B))||void 0===l?void 0:l.nickName})]},e.id)})}),(0,r.jsxs)("div",{className:"grid h-[920px] grid-cols-7 gap-10 pt-4 mobile-tablet:pt-5",children:[(0,r.jsx)("div",{className:"col-span-2 flex flex-col gap-4 overflow-y-auto rounded-xl bg-color-gray-50 p-8 mobile-tablet:hidden card:hidden",children:ee?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):H.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>et(e),className:"flex cursor-pointer gap-4 rounded-xl border border-color-line-100 p-4 hover:scale-[1.1] ".concat((null==h?void 0:h.id)===e.id?"bg-color-blue-100":"bg-[#fcfcfc]"),children:[(0,r.jsx)("div",{children:(0,r.jsx)(y(),{src:null===(t=b.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==B))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("p",{children:null===(l=e.users.find(e=>e.id!==B))||void 0===l?void 0:l.nickName}),(0,r.jsx)("p",{className:"line-clamp-2",children:e.lastChat})]})]},e.id)})}),(0,r.jsxs)("div",{className:"col-span-5 rounded-xl bg-color-gray-50 p-8 mobile-tablet:col-span-7 card:col-span-7",children:[null===h?"":(0,r.jsxs)("div",{className:"mb-4 rounded-lg border border-color-line-100 p-4",children:[(0,r.jsx)("p",{className:"semibold text-2xl text-color-black-300 mobile-tablet:text-xl",children:null==h?void 0:h.planTitle}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"여행일"}),(0,r.jsx)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:(0,u.nk)((null==h?void 0:h.planTripDate)||"")}),(0,r.jsxs)("div",{className:"flex flex-row",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"플랜가"}),(0,r.jsx)(y(),{src:N.A,alt:"코코넛",width:30})]}),(0,r.jsxs)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:[null==h?void 0:h.quotePrice," P"]})]})]}),(0,r.jsx)("div",{className:"h-[600px] overflow-y-auto mobile-tablet:h-[650px]",ref:q,children:e.slice().reverse().map((e,t)=>(0,r.jsxs)("div",{children:[0===t&&J&&(0,r.jsx)("div",{className:"text-color-blue-500 semibold my-4 text-center",children:"첫 번째 메시지입니다."}),(0,r.jsxs)("div",{onClick:()=>Y(e.id),className:"relative mb-2 cursor-pointer",children:[(0,r.jsx)(n.A,{type:e.senderId===B?"right":"left_say",children:e.isDeleted?(0,r.jsxs)("p",{className:"text-color-gray-50",children:["TEXT"===e.type&&"삭제된 메시지입니다.","IMAGE"===e.type&&"삭제된 이미지입니다.","VIDEO"===e.type&&"삭제된 동영상입니다."]}):"IMAGE"===e.type?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("img",{src:e.content||"",alt:"file",className:"w-56 rounded-lg"})}),(0,r.jsx)(y(),{src:w,alt:"다운로드",className:"absolute bottom-0 right-2 h-8 w-8 cursor-pointer",onClick:t=>{el(e.id),t.stopPropagation()}})]}):"VIDEO"===e.type?(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("video",{controls:!0,className:"h-96 rounded-lg",children:(0,r.jsx)("source",{src:e.content||"",type:"video/mp4"})})}),(0,r.jsx)(y(),{src:w,alt:"다운로드",className:"absolute bottom-0 right-2 h-8 w-8 cursor-pointer",onClick:t=>{el(e.id),t.stopPropagation()}})]}):(0,r.jsx)("p",{children:e.content})},e.id),U===e.id&&!e.isDeleted&&(0,r.jsx)("div",{onClick:t=>{t.stopPropagation(),Z(e.id,e.senderId,e.createdAt),P(null)},className:"bold absolute bottom-0 right-0 w-[107px] cursor-pointer rounded-md border border-color-black-500 bg-color-gray-100 px-2",children:"메시지 삭제"})]})]},e.id))}),(0,r.jsxs)("div",{className:"flex flex-col gap-5",ref:O,children:[(0,r.jsx)("input",{className:"h-16 w-full rounded-xl bg-color-background-200 indent-5 text-color-black-500 outline-none mobile-tablet:h-10",placeholder:"텍스트를 입력해 주세요.",onChange:e=>p(e.target.value),value:l,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),V())}}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("input",{type:"file",className:"hidden",id:"fileUpload",onChange:e=>{let t=e.target.files?e.target.files[0]:null;if(t){let l=t.name.match(/\.(jpg|jpeg|png)$/i),r=t.name.match(/\.(mp4|mov)$/i);if(l&&t.size>5242880){alert("이미지는 5MB 이하로 업로드할 수 있습니다."),e.target.value="";return}if(r&&t.size>0x6400000){alert("비디오는 100MB 이하로 업로드할 수 있습니다."),e.target.value="";return}C&&URL.revokeObjectURL(C);let a=URL.createObjectURL(t);_(t),I(a),e.target.value=""}}}),(0,r.jsx)("label",{htmlFor:"fileUpload",className:"cursor-pointer rounded-xl border border-color-blue-300 bg-color-blue-100 px-6 py-3 text-lg text-color-blue-300 mobile-tablet:px-4 mobile-tablet:py-1",children:"첨부파일"}),(0,r.jsx)("button",{onClick:V,className:"rounded-xl bg-color-blue-300 px-6 py-3 text-lg text-color-gray-50 mobile-tablet:px-4 mobile-tablet:py-1",children:"전송"})]}),C&&(0,r.jsx)("div",{className:"mb-3 mt-3",children:(()=>{var e;if(!C)return null;let t=null==R?void 0:null===(e=R.name.split(".").pop())||void 0===e?void 0:e.toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("img",{src:C,alt:"file-preview",className:"h-auto w-28 rounded-lg"}),(0,r.jsx)("button",{onClick:er,className:"absolute left-[85px] top-1 rounded-full bg-color-red-200 px-2 text-color-gray-50 hover:bg-color-red-100",children:(0,r.jsx)("p",{children:"x"})})]}):"mp4"===t||"mov"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("video",{controls:!0,className:"h-auto w-full rounded-lg",children:(0,r.jsx)("source",{src:C,type:"video/".concat(t)})}),(0,r.jsx)("button",{onClick:er,className:"absolute right-2 top-2 rounded-full bg-white p-2 text-color-red-200 hover:bg-gray-200",children:(0,r.jsx)("span",{className:"text-xl",children:"x"})})]}):(0,r.jsx)("p",{children:"지원되지 않는 파일 형식입니다. (이미지는 jpg, jpeg, png / 비디오는 mp4, mov만 업로드 가능)"})})()})]})]})]})]})})]})}function C(){return(0,r.jsx)(k,{})}let I=(0,l(4107).A)(C)},4107:(e,t,l)=>{"use strict";l.d(t,{A:()=>u});var r=l(77528),a=l(74848),s=l(96540),o=l(86715),n=l(12828),i=l(5279),c=l(29965),d=l.n(c);let u=e=>t=>{let l=(0,o.useRouter)(),[c,u]=(0,s.useState)(null),[p,h]=(0,s.useState)(!0);return((0,s.useEffect)(()=>{let e=(0,n.iD)();if(e){if("/login"===l.pathname||"/signup"===l.pathname){l.push("/");return}u(e)}else"/login"!==l.pathname&&"/signup"!==l.pathname&&l.push("/login");h(!1)},[l]),p)?(0,a.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,a.jsx)(d(),{src:i.A,alt:"로딩 중"})}):c||"/login"===l.pathname||"/signup"===l.pathname?(0,a.jsx)(e,(0,r._)({},t)):null}}},e=>{var t=t=>e(e.s=t);e.O(0,[913,636,593,792],()=>t(50531)),_N_E=e.O()}]);