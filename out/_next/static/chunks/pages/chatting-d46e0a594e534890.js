try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="83ff002b-251d-482a-83c4-d41bcfeebc06",e._sentryDebugIdIdentifier="sentry-dbid-83ff002b-251d-482a-83c4-d41bcfeebc06")}catch(e){}(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[902],{50531:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chatting",function(){return l(17521)}])},94002:(e,t,l)=>{"use strict";l.d(t,{A:()=>r});let r={src:"/_next/static/media/icon_loading.05325840.gif",height:45,width:256,blurWidth:0,blurHeight:0}},31084:(e,t,l)=>{"use strict";l.d(t,{A:()=>a});var r=l(74848);function a(e){let{type:t="left",children:l}=e,a="";return"left"===t?a="bg-color-gray-50 rounded-r-3xl rounded-bl-3xl":"right"===t?a="bg-color-blue-300 rounded-l-3xl rounded-br-3xl text-color-gray-50":"right_select"===t?a="bg-color-gray-50 rounded-l-3xl rounded-br-3xl ":"left_say"===t&&(a="bg-color-blue-100 text-color-blue-300 rounded-r-3xl rounded-bl-3xl"),(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"".concat("left"===t||"left_say"===t?"flex justify-start":"flex justify-end"," pb-8"),children:(0,r.jsx)("div",{className:"".concat(a," bold w-fit max-w-full px-5 py-3"),children:l})})})}},37452:(e,t,l)=>{"use strict";l.d(t,{A:()=>o});var r=l(74848),a=l(96540);function o(e){let{children:t,bodyClass:l}=e;return(0,a.useEffect)(()=>(l&&document.body.classList.add(l),()=>{l&&document.body.classList.remove(l)}),[l]),(0,r.jsx)(r.Fragment,{children:t})}},17521:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>w});var r=l(74848),a=l(37452),o=l(29965),n=l.n(o),s=l(31084),c=l(96540),i=l(5177),d=l(54787);let u={getChatRooms:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;try{return(await i.F.get("/chatRooms?page=".concat(e,"&pageSize=").concat(t))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,planId:e.planId,planTitle:e.planTitle,planTripDate:e.planTripDate,quotePrice:e.quotePrice,lastChat:e.lastChat,isActive:e.isActive,users:e.users.map(e=>({id:e.id,nickName:e.nickName,image:e.image}))}))}catch(e){throw console.error("채팅방 목록 get 실패",e),e}},getMessages:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{return(await i.F.get("/chatRooms/".concat(e,"/chats?page=").concat(t,"&pageSize=").concat(l))).list.map(e=>({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,senderId:e.senderId,chatRoomId:e.chatRoomId,content:e.content,type:e.type,isDeleted:e.isDeleted}))}catch(e){throw console.error("메시지 목록 get 실패",e),e}},connectWebSocket:(e,t,l)=>{let r=(0,d.io)("wss://www.goforme.duckdns.org",{transports:["websocket"],auth:{token:"".concat(e)}});return r.on("ServerToClientMessage",e=>{t(e)}),r.on("ERROR",e=>{l(e),console.error("에러발생! ".concat(e.message))}),r.on("connect",()=>{console.log("웹소켓 연결 성공 ✅")}),r.on("disconnect",()=>{console.log("웹소켓 연결 종료 ❌")}),r},sendMessage:(e,t,l,r)=>{e.emit("ClientToServerMessage",{chatRoomId:t,type:r,content:l})},fileUpload:async(e,t)=>{try{let{id:l,createdAt:r,updatedAt:a,senderId:o,type:n,chatRoomId:s,content:c}=await i.F.post("/chatRooms/".concat(e,"/chats"),t,!1,{headers:{"Content-Type":"multipart/form-data"}});return{id:l,createdAt:r,updatedAt:a,senderId:o,type:n,chatRoomId:s,content:c}}catch(e){throw console.error("파일 업로드 실패",e),e}},deleteMessage:async e=>{try{return await i.F.delete("/chats/".concat(e))}catch(e){console.error("메시지 삭제 실패",e)}}};var m=l(94791),p=l(97286),g=l(69340),x=l(93172),h=l(74819),b=l(21303),f=l(94002),y=l(2385);let v=async()=>(await g.A.getUserInfo()).id;function j(){let[e,t]=(0,c.useState)([]),[l,o]=(0,c.useState)(""),[i,d]=(0,c.useState)(null),[g,j]=(0,c.useState)(null),[w,N]=(0,c.useState)(1),[k,A]=(0,c.useState)(null),[I,E]=(0,c.useState)(null),[T,C]=(0,c.useState)(!1),[D,R]=(0,c.useState)(!1),[_,S]=(0,c.useState)(!0),[F,M]=(0,c.useState)(null),L=(0,c.useRef)(null),O=(0,c.useRef)(null),{data:U=""}=(0,p.I)({queryKey:["userId"],queryFn:v}),{data:q=[],isLoading:P}=(0,p.I)({queryKey:["chatRooms"],queryFn:async()=>await u.getChatRooms(1,10)}),X=async()=>{if(i){if(!g){console.error("소켓이 연결되어 있지 않습니다.");return}if((l.trim()||I)&&i){let e=I&&I.name.match(/\.(jpg|jpeg|png)$/i),r=I&&I.name.match(/\.(mp4|mov)$/i),a={id:(0,b.A)(),senderId:Array.isArray(U)?U[0]:U,chatRoomId:i.id,type:e?"IMAGE":r?"VIDEO":"TEXT",content:I?null:l.trim(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};I?await $(i.id,I,a):(u.sendMessage(g,i.id,l.trim(),"TEXT"),t(e=>[a,...e])),o(""),Q(),z()}}},$=async(e,l,r)=>{let a=l.name.match(/\.(jpg|jpeg|png)$/i)?"IMAGE":"VIDEO",o=new FormData;o.append("type",a),o.append("file",l);try{let l=await u.fileUpload(e,o),a={...r,content:l.content};t(e=>[a,...e])}catch(e){console.error("파일 업로드 실패::",e)}},z=()=>{O.current&&(O.current.scrollTop=O.current.scrollHeight)},G=()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},H=(0,c.useCallback)(()=>{if(!O.current||!i||T||!_)return;let{scrollTop:e,scrollHeight:t}=O.current;0!==e||T||(C(!0),V(i.id,w+1,!0).then(()=>{N(e=>e+1),C(!1),requestAnimationFrame(()=>{O.current&&(O.current.scrollTop=O.current.scrollHeight-t)})}))},[T,_,w,i]);(0,c.useEffect)(()=>{if(!i)return;let e=O.current;if(e)return e.addEventListener("scroll",H),()=>{e.removeEventListener("scroll",H)}},[i,H]);let V=async function(e,l){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let a=await u.getMessages(e,l,10);if(0===a.length){S(!1),1!==l&&R(!0);return}a.length>0&&l>1&&R(!1),t(e=>{let t=a.filter(t=>!e.some(e=>e.id===t.id));return[...e,...t]}),r?K():requestAnimationFrame(()=>{z()})}catch(e){console.error("메시지를 가져오는데 실패했습니다.",e)}},K=()=>{if(O.current){let{scrollTop:e}=O.current;0===e?O.current.scrollTop=0:O.current.scrollTop=e}},W=e=>{M(t=>t===e?null:e)},B=async(e,l,r)=>{let a=new Date,o=new Date(r);if(a.getTime()-o.getTime()>3e5){alert("메시지는 5분 이내에만 삭제할 수 있습니다.");return}if(l!==U){alert("자신의 메시지만 삭제할 수 있습니다.");return}if(window.confirm("메시지를 삭제하시겠습니까?"))try{await u.deleteMessage(e),t(t=>t.map(t=>t.id===e?{...t,isDeleted:!0}:t))}catch(e){console.error("메시지 삭제 실패:",e),alert("메시지 삭제에 실패했습니다.")}},J=async e=>{d(e),t([]),await V(e.id,1,!1),z(),G()};(0,c.useEffect)(()=>{let e=(0,y.iD)();if(e){let l=u.connectWebSocket(e,e=>{t(t=>t.find(t=>t.id===e.id)?t:[e,...t])},e=>{alert("".concat(e.message))});return j(l),()=>{l&&l.close()}}},[]),(0,c.useEffect)(()=>{i&&(t([]),N(1),R(!1),S(!0),V(i.id,1,!1))},[i]),(0,c.useEffect)(()=>{e.length>0&&z()},[e]);let Q=()=>{k&&URL.revokeObjectURL(k),A(null),E(null)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"-mx-[260px] bg-color-gray-50 py-6 mobile-tablet:mb-5 card:mb-5",children:(0,r.jsx)("p",{className:"semibold pl-[260px] text-xl",children:"메시지"})}),(0,r.jsx)(a.A,{bodyClass:"bg-gray","data-sentry-element":"Layout","data-sentry-source-file":"ChattingForm.tsx",children:P?(0,r.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,r.jsx)(n(),{src:f.A,alt:"로딩 중"})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"gap-4 overflow-x-auto rounded-xl border border-color-line-200 bg-color-gray-50 p-4 pc:hidden mobile-tablet:flex card:flex",children:0===q.length?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):q.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>J(e),className:"flex cursor-pointer flex-col rounded-lg p-3 ".concat((null==i?void 0:i.id)===e.id?"bg-color-blue-100":"bg-color-gray-50"),children:[(0,r.jsx)(n(),{src:null===(t=m.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==U))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"}),(0,r.jsx)("p",{className:"bold mt-3 text-center",children:null===(l=e.users.find(e=>e.id!==U))||void 0===l?void 0:l.nickName})]},e.id)})}),(0,r.jsxs)("div",{className:"grid h-[920px] grid-cols-7 gap-10 pt-4 mobile-tablet:pt-5",children:[(0,r.jsx)("div",{className:"col-span-2 flex flex-col gap-4 overflow-y-auto rounded-xl bg-color-gray-50 p-8 mobile-tablet:hidden card:hidden",children:0===q.length?(0,r.jsx)("p",{children:"채팅방 목록이 없습니다."}):q.map(e=>{var t,l;return(0,r.jsxs)("div",{onClick:()=>J(e),className:"flex cursor-pointer gap-4 rounded-xl border border-color-line-100 p-4 ".concat((null==i?void 0:i.id)===e.id?"bg-color-blue-100":"bg-white"),children:[(0,r.jsx)("div",{children:(0,r.jsx)(n(),{src:null===(t=m.A.find(t=>{var l;return t.key===(null===(l=e.users.find(e=>e.id!==U))||void 0===l?void 0:l.image)}))||void 0===t?void 0:t.src,alt:"유저",width:70,className:"rounded-full"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsx)("p",{children:null===(l=e.users.find(e=>e.id!==U))||void 0===l?void 0:l.nickName}),(0,r.jsx)("p",{className:"line-clamp-2",children:e.lastChat})]})]},e.id)})}),(0,r.jsxs)("div",{className:"col-span-5 rounded-xl bg-color-gray-50 p-8 mobile-tablet:col-span-7 card:col-span-7",children:[null===i?"":(0,r.jsxs)("div",{className:"mb-4 rounded-lg border border-color-line-100 p-4",children:[(0,r.jsx)("p",{className:"semibold text-2xl text-color-black-300 mobile-tablet:text-xl",children:null==i?void 0:i.planTitle}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"여행일"}),(0,r.jsx)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:(0,x.nk)((null==i?void 0:i.planTripDate)||"")}),(0,r.jsxs)("div",{className:"flex flex-row",children:[(0,r.jsx)("p",{className:"regular text-xl text-color-gray-500 mobile-tablet:text-2lg",children:"플랜가"}),(0,r.jsx)(n(),{src:h.A,alt:"코코넛",width:30})]}),(0,r.jsxs)("p",{className:"medium text-color-balck-400 text-xl mobile-tablet:text-2lg",children:[null==i?void 0:i.quotePrice," P"]})]})]}),(0,r.jsx)("div",{className:"h-[600px] overflow-y-auto mobile-tablet:h-[650px]",ref:O,children:e.slice().reverse().map((e,t)=>(0,r.jsxs)("div",{children:[0===t&&D&&!_&&(0,r.jsx)("div",{className:"text-color-blue-500 semibold my-4 text-center",children:"첫 번째 메시지입니다."}),(0,r.jsxs)("div",{onClick:()=>W(e.id),className:"relative mb-2 cursor-pointer",children:[(0,r.jsx)(s.A,{type:e.senderId===U?"right":"left_say",children:e.isDeleted?(0,r.jsxs)("p",{className:"text-color-gray-50",children:["TEXT"===e.type&&"삭제된 메시지입니다.","IMAGE"===e.type&&"삭제된 이미지입니다.","VIDEO"===e.type&&"삭제된 동영상입니다."]}):"IMAGE"===e.type?(0,r.jsx)("img",{src:e.content||"",alt:"file",className:"w-56 rounded-lg"}):"VIDEO"===e.type?(0,r.jsx)("video",{controls:!0,className:"h-96 rounded-lg",children:(0,r.jsx)("source",{src:e.content||"",type:"video/mp4"})}):(0,r.jsx)("p",{children:e.content})},e.id),F===e.id&&!e.isDeleted&&(0,r.jsx)("div",{onClick:t=>{t.stopPropagation(),B(e.id,e.senderId,e.createdAt),M(null)},className:"bold absolute bottom-0 right-0 w-[107px] cursor-pointer rounded-md border border-color-black-500 bg-color-gray-100 px-2",children:"메시지 삭제"})]})]},e.id))}),(0,r.jsxs)("div",{className:"flex flex-col gap-5",ref:L,children:[(0,r.jsx)("input",{className:"h-16 w-full rounded-xl bg-color-background-200 indent-5 text-color-black-500 outline-none mobile-tablet:h-10",placeholder:"텍스트를 입력해 주세요.",onChange:e=>o(e.target.value),value:l,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),X())}}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("input",{type:"file",className:"hidden",id:"fileUpload",onChange:e=>{let t=e.target.files?e.target.files[0]:null;if(t){let l=t.name.match(/\.(jpg|jpeg|png)$/i),r=t.name.match(/\.(mp4|mov)$/i);if(l&&t.size>5242880){alert("이미지는 5MB 이하로 업로드할 수 있습니다."),e.target.value="";return}if(r&&t.size>0x6400000){alert("비디오는 100MB 이하로 업로드할 수 있습니다."),e.target.value="";return}k&&URL.revokeObjectURL(k);let a=URL.createObjectURL(t);E(t),A(a),e.target.value=""}}}),(0,r.jsx)("label",{htmlFor:"fileUpload",className:"cursor-pointer rounded-xl border border-color-blue-300 bg-color-blue-100 px-6 py-3 text-lg text-color-blue-300 mobile-tablet:px-4 mobile-tablet:py-1",children:"첨부파일"}),(0,r.jsx)("button",{onClick:X,className:"rounded-xl bg-color-blue-300 px-6 py-3 text-lg text-color-gray-50 mobile-tablet:px-4 mobile-tablet:py-1",children:"전송"})]}),k&&(0,r.jsx)("div",{className:"mb-3 mt-3",children:(()=>{var e;if(!k)return null;let t=null==I?void 0:null===(e=I.name.split(".").pop())||void 0===e?void 0:e.toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("img",{src:k,alt:"file-preview",className:"h-auto w-28 rounded-lg"}),(0,r.jsx)("button",{onClick:Q,className:"absolute left-[85px] top-1 rounded-full bg-color-red-200 px-2 text-color-gray-50 hover:bg-color-red-100",children:(0,r.jsx)("p",{children:"x"})})]}):"mp4"===t||"mov"===t?(0,r.jsxs)("div",{className:"relative h-auto w-full",children:[(0,r.jsx)("video",{controls:!0,className:"h-auto w-full rounded-lg",children:(0,r.jsx)("source",{src:k,type:"video/".concat(t)})}),(0,r.jsx)("button",{onClick:Q,className:"absolute right-2 top-2 rounded-full bg-white p-2 text-color-red-200 hover:bg-gray-200",children:(0,r.jsx)("span",{className:"text-xl",children:"x"})})]}):(0,r.jsx)("p",{children:"지원되지 않는 파일 형식입니다. (이미지는 jpg, jpeg, png / 비디오는 mp4, mov만 업로드 가능)"})})()})]})]})]})]})})]})}function w(){return(0,r.jsx)(j,{"data-sentry-element":"ChattingForm","data-sentry-component":"ChattingPage","data-sentry-source-file":"index.tsx"})}}},e=>{var t=t=>e(e.s=t);e.O(0,[913,636,593,792],()=>t(50531)),_N_E=e.O()}]);